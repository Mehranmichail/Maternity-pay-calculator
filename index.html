<script type="text/javascript">
(function () {
  // -- CONFIG (update if HMRC publishes new rates) --
  var SMP_STANDARD_RATE = 187.18;   // standard rate for weeks 7-39 (change if HMRC updates)
  var SMP_LEL = 125.00;             // lower earnings limit / weekly minimum (change if required)
  var TOTAL_SMP_WEEKS = 39;
  var FIRST_6_WEEKS = 6;
  var REMAINING_WEEKS = TOTAL_SMP_WEEKS - FIRST_6_WEEKS;

  // Utility: zero time (use UTC to avoid timezone shifts)
  function startOfDayUTC(date) {
    var d = new Date(date.getTime());
    d.setUTCHours(0,0,0,0);
    return d;
  }

  // Utility: format GBP
  function gbp(n) {
    return parseFloat(n).toFixed(2);
  }

  // Returns the Sunday on or before the given date (EWC start as HMRC defines)
  function sundayOnOrBefore(date) {
    var d = startOfDayUTC(new Date(date));
    var dow = d.getUTCDay(); // 0 = Sunday
    d.setUTCDate(d.getUTCDate() - dow);
    return startOfDayUTC(d);
  }

  // Compute qualifying week start/end: 15 weeks BEFORE EWC_start
  function qualifyingWeekForDueDate(dueDate) {
    var ewcStart = sundayOnOrBefore(new Date(dueDate));
    var qStart = new Date(ewcStart.getTime() - 15 * 7 * 24 * 60 * 60 * 1000); // 15 weeks earlier
    var qEnd = new Date(qStart.getTime() + 6 * 24 * 60 * 60 * 1000);
    return { qStart: startOfDayUTC(qStart), qEnd: startOfDayUTC(qEnd), ewcStart: ewcStart };
  }

  // Converts array of numeric earnings into average weekly earnings depending on frequency.
  // entries: array of numbers (non-empty entries only should be passed)
  // freq: "weekly", "fortnightly", "4-weekly", "monthly"
  // returns { avgWeekly: number, usedPeriods: number, weeksCovered: number }
  function computeAWE(entries, freq) {
    var sum = entries.reduce(function (s, v) { return s + v; }, 0);
    var pays = entries.length;
    if (pays === 0) return { avgWeekly: 0, usedPeriods: 0, weeksCovered: 0 };

    if (freq === 'weekly') {
      // HMRC: use last 8 weeks (ideally). We will require 8 entries to be accurate.
      var weeksCovered = pays;
      return { avgWeekly: sum / weeksCovered, usedPeriods: pays, weeksCovered: weeksCovered };
    } else if (freq === 'fortnightly') {
      // each entry = 2 weeks
      var weeksCovered = pays * 2;
      return { avgWeekly: sum / weeksCovered, usedPeriods: pays, weeksCovered: weeksCovered };
    } else if (freq === '4-weekly') {
      // each entry = 4 weeks
      var weeksCovered = pays * 4;
      return { avgWeekly: sum / weeksCovered, usedPeriods: pays, weeksCovered: weeksCovered };
    } else if (freq === 'monthly') {
      // HMRC: use the last 2 whole months (or whole pay periods). Convert monthly to weekly:
      // average weekly = (monthly average * 12) / 52
      var monthlyAvg = sum / pays;
      var avgWeekly = (monthlyAvg * 12) / 52;
      var weeksCovered = (12 / 52) * pays * 52 / 12; // just for info, equals pays * (52/12)
      return { avgWeekly: avgWeekly, usedPeriods: pays, weeksCovered: (pays * (52/12)) };
    } else {
      // fallback treat as weekly
      var weeksCovered = pays;
      return { avgWeekly: sum / weeksCovered, usedPeriods: pays, weeksCovered: weeksCovered };
    }
  }

  // Validation requirement per frequency ‚Äî number of entries expected for accurate result
  var REQUIRED_ENTRIES = {
    'weekly': 8,
    'fortnightly': 4,   // 4 pays cover 8 weeks
    '4-weekly': 2,      // 2 pays cover 8 weeks
    'monthly': 2
  };

  // Main calculate function (wired to your button)
  var btn = document.getElementById('smpCalcButton');
  if (!btn) return;
  btn.addEventListener('click', function () {
    try {
      var dueDateVal = document.getElementById('dueDate').value;
      var empStartVal = document.getElementById('employmentStart').value;
      var freq = (document.getElementById('payFrequency') && document.getElementById('payFrequency').value) || 'weekly';

      if (!dueDateVal || !empStartVal || !freq) {
        alert('Please fill in due date, employment start date and pay frequency.');
        return;
      }

      var dueDate = new Date(dueDateVal);
      var empStart = startOfDayUTC(new Date(empStartVal));
      var q = qualifyingWeekForDueDate(dueDate);
      var qStart = q.qStart, qEnd = q.qEnd;

      // Collect earnings based on detected/supplied frequency.
      var earningsEntries = [];
      if (freq === 'weekly') {
        for (var i = 1; i <= 8; i++) {
          var el = document.getElementById('w' + i);
          if (el && el.value !== '') earningsEntries.push(parseFloat(el.value));
        }
      } else if (freq === 'monthly') {
        for (var i = 1; i <= 2; i++) {
          var el = document.getElementById('m' + i);
          if (el && el.value !== '') earningsEntries.push(parseFloat(el.value));
        }
      } else if (freq === 'fortnightly') {
        // look for elements with class 'fn-earning' or fallback to weekly input grouping (w1..w8)
        for (var i = 1; i <= 4; i++) {
          var el = document.getElementById('fn' + i);
          if (el && el.value !== '') earningsEntries.push(parseFloat(el.value));
        }
      } else if (freq === '4-weekly') {
        for (var i = 1; i <= 2; i++) {
          var el = document.getElementById('four' + i);
          if (el && el.value !== '') earningsEntries.push(parseFloat(el.value));
        }
      }

      // If user didn't include required number of entries, stop and ask for correct input
      var required = REQUIRED_ENTRIES[freq] || 8;
      if (earningsEntries.length < required) {
        alert('Please enter at least ' + required + ' pay period entries for accurate AWE calculation for ' + freq + ' pay. You entered ' + earningsEntries.length + '.');
        return;
      }

      // Compute AWE and eligibility
      var aweObj = computeAWE(earningsEntries, freq);
      var avgWeekly = aweObj.avgWeekly;
      var earnPassed = avgWeekly >= SMP_LEL;

      // Continuous employment check:
      // Employee must have started employment on or before (qualifyingWeekEnd - 26 weeks)
      var requiredStartDate = new Date(qEnd.getTime() - 26 * 7 * 24 * 60 * 60 * 1000);
      requiredStartDate = startOfDayUTC(requiredStartDate);
      var empPassed = empStart <= requiredStartDate;

      // SMP calculation: first 6 weeks = 90% of AWE, remaining 33 weeks = lower of standard rate or 90% AWE
      var rate90 = avgWeekly * 0.90;
      var first6Rate = rate90;
      var remainingRate = Math.min(SMP_STANDARD_RATE, rate90);

      var totalFirst6 = first6Rate * FIRST_6_WEEKS;
      var totalRemaining = remainingRate * REMAINING_WEEKS;
      var totalSMP = totalFirst6 + totalRemaining;

      var eligible = empPassed && earnPassed;

      // BUILD HTML output (keeps your styling)
      function formatDate(d) {
        return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
      }

      var html = '<div class="smp-result-card ' + (eligible ? 'eligible' : 'not-eligible') + '">';
      html += '<div class="smp-result-header"><div class="smp-status-icon">' + (eligible ? '‚úÖ' : '‚ùå') + '</div>';
      html += '<div><div class="smp-result-title">' + (eligible ? 'Eligible for SMP' : 'Not Eligible for SMP') + '</div>';
      html += '<div style="color: #666;">Based on information provided</div></div></div>';

      html += '<div style="margin-bottom: 20px;"><strong>Due Date:</strong> ' + formatDate(dueDate) + '<br>';
      html += '<strong>Qualifying Week:</strong> ' + formatDate(qStart) + ' to ' + formatDate(qEnd) + '</div>';

      html += '<div style="margin: 20px 0 10px 0; font-weight: 600;">Eligibility Checks:</div>';

      html += '<div class="smp-check-item ' + (empPassed ? 'pass' : 'fail') + '"><div>';
      html += '<div class="smp-check-label">Continuous Employment (started on or before ' + formatDate(requiredStartDate) + ')</div>';
      html += '<div class="smp-check-value">Employment start: ' + formatDate(empStart) + '</div></div>';
      html += '<div class="smp-check-status ' + (empPassed ? 'pass' : 'fail') + '">' + (empPassed ? 'PASS' : 'FAIL') + '</div></div>';

      html += '<div class="smp-check-item ' + (earnPassed ? 'pass' : 'fail') + '"><div>';
      html += '<div class="smp-check-label">Average Weekly Earnings (minimum ¬£' + SMP_LEL.toFixed(2) + '/week)</div>';
      html += '<div class="smp-check-value">Average weekly earnings: ¬£' + gbp(avgWeekly) + ' (based on ' + aweObj.usedPeriods + ' pay period(s))</div></div>';
      html += '<div class="smp-check-status ' + (earnPassed ? 'pass' : 'fail') + '">' + (earnPassed ? 'PASS' : 'FAIL') + '</div></div>';

      if (eligible) {
        html += '<div class="smp-payment-breakdown"><div class="smp-payment-title">üí∑ SMP Payment Breakdown</div>';
        html += '<div style="text-align: center; margin-bottom: 20px;">Average Weekly Earnings: <strong>¬£' + gbp(avgWeekly) + '</strong></div>';
        html += '<div class="smp-payment-row"><div><div class="smp-payment-label">Weeks 1-' + FIRST_6_WEEKS + '</div><div style="font-size: 13px; opacity: 0.9;">90% of average weekly earnings</div></div>';
        html += '<div><div class="smp-payment-amount">¬£' + gbp(first6Rate) + '/week</div><div style="font-size: 14px;">Total: ¬£' + gbp(totalFirst6) + '</div></div></div>';
        html += '<div class="smp-payment-row"><div><div class="smp-payment-label">Weeks ' + (FIRST_6_WEEKS + 1) + '-' + TOTAL_SMP_WEEKS + '</div><div style="font-size: 13px; opacity: 0.9;">Lower of standard rate (¬£' + SMP_STANDARD_RATE.toFixed(2) + ') or 90% AWE</div></div>';
        html += '<div><div class="smp-payment-amount">¬£' + gbp(remainingRate) + '/week</div><div style="font-size: 14px;">Total: ¬£' + gbp(totalRemaining) + '</div></div></div>';
        html += '<div class="smp-total-row">Estimated total SMP (39 weeks): ¬£' + gbp(totalSMP) + '</div></div>';
        html += '<div class="smp-warning-box"><strong>‚ö†Ô∏è Important:</strong> SMP payments are subject to tax and National Insurance. Rates shown above use the configured standard rate and LEL; update config if HMRC publishes new figures.</div>';
      } else {
        html += '<div class="smp-warning-box"><strong>‚ÑπÔ∏è Result:</strong> Based on the information provided you are not eligible for SMP. You may qualify for Maternity Allowance ‚Äî see GOV.UK for details.</div>';
      }

      html += '</div>';

      var r = document.getElementById('results');
      if (r) {
        r.innerHTML = html;
        r.style.display = 'block';
        setTimeout(function () { r.scrollIntoView({ behavior: 'smooth' }); }, 100);
      } else {
        alert('Results element not found.');
      }

    } catch (err) {
      console.error(err);
      alert('Calculation error. Please check your inputs.');
    }
  });
})();
</script>
